<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body onload="callAzureOpenAI()">
    <header>
      <h1>Recovery Journey</h1>
  </header>
  <section id="dashboard">
    <div class="header">
        <h1>Welcome, <span id="userName"></span></h1>
        <h1 id="motivatinalMessage"></h1>
        <div class="con">
        <button id="logout">
            <a href="login.html"><span><i class="fa-solid fa-sign-out"></i></span></a>
        </button>
        <button>
            <a href="tasks.html"><span><i class="fa-solid fa-book"></i></span></a>
        </button>
    </div>
    <div class="moods">
        <h2>How are you feeling today?</h2>
        <div class="moods-btn">
            <button class="btn-mood" onclick="logMood('ðŸ˜€ Happy')">ðŸ˜€</button>
            <button class="btn-mood" onclick="logMood('ðŸ˜¡ Angry')">ðŸ˜¡</button>
            <button class="btn-mood" onclick="logMood('ðŸ˜¢ Sad')">ðŸ˜¢</button>
        </div>
    </div>

    <div id="mood-log">
        <h2>Past Mood logs</h2>
        <div id="log-entries"></div>
    </div>

        <div id="chatContainer">
            <h2>Recovery Support Chatbot</h2>
            <div id="chatMessages">
              <p><strong>RecoveryBot:</strong> Hello! I'm here to support you on your journey. How are you feeling today?</p>
            </div>
            <input type="text" id="userInput" placeholder="Type your message here..." />
            <button id="sendBtn">Send</button>
          </div>

    <div class="progress">
        <h2>Your Progress</h2>
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
     </div>

        <p id="progress-text">You have completed <span id="completedDays">0</span> out of 75 days.</p>
    </div> 
    <div class="tasks">
        <h1>Your Tasks</h1>
        <ul id="tasksList"></ul>
    </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
<script src="api.js"></script>
<script type="module" defer src="chatbot.js"></script>
</body>
<script type="module" defer>
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    getDocs
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAGaZKB4VAmQRV-wsJanZhEmTz5QNLBfD0",
    authDomain: "ai-fluency-1cd86.firebaseapp.com",
    projectId: "ai-fluency-1cd86",
    storageBucket: "ai-fluency-1cd86.firebasestorage.app",
    messagingSenderId: "230668708493",
    appId: "1:230668708493:web:48ade94203de75fa94d0c4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const userName = document.getElementById('userName');
  const progress = document.getElementById('progress'); 
  const progressText = document.getElementById('progress-text');
  const completedDays = document.getElementById('completedDays');
  const tasksList = document.getElementById('tasksList');
  const logoutButton = document.getElementById('logout');

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userId = user.uid;

      try {
        if (!userId) {
          console.error("User ID is undefined or null.");
          return;
        }
        const userDocRef = doc(db, 'users', userId);
        const userDocSnap = await getDoc(userDocRef);
        const userData = userDocSnap.data();

        userName.innerText = userData.fullName || "";
        const completedTasks = userData.completedTasks || 0;
        const totalTasks = 75;
        const progressPercentage = (completedTasks / totalTasks) * 100;
        progress.style.width = `${progressPercentage}%`;
        progressText.innerText = `You have completed ${completedTasks} out of ${totalTasks} days.`;
        completedDays.innerText = completedTasks;

            db.collection('users').doc(user.uid).collection('tasks').get().then(snapshot =>{
                snapshot.forEach(taskDoc =>{
                    const listItem = document.createElement('li');
                    listItem.textContent = taskDoc.data().taskName;
                    taskList.appendChild(listItem);
                });
            });
        } else {
            window.location.href = "login.html";
            console.log("User logged out");
        }
    });

    logoutButton.addEventListener('click', () =>{
        auth.signOut().then(() => {
            console.log("User logged Out"),
            window.location.href = "login.html";
        }) .catch(error => {
            console.error("Error logging out", error)
        });

        let currentUser;

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loadMoodLog(currentUser.uid);
            }

            async function loadMoodLog(uid) {
                const moodRef = collection(db, 'users', uid, 'moods');
                const logContainer = document.getElementById('log-entries');
                logContainer.innerHTML = '';
                const snapshot = await getDocs(moodRef);
                snapshot.forEach(doc => {
                    const entry = doc.data();
                    const div = document.createElement('div');
                    div.classList.add('entry');
                    div.textContent = `${entry.mood} - ${entry.timestamp?.toDate().toLocaleString() || 'Just now'}`;
                    logContainer.appendChild(div);
                });
            }
        })
    });
</script>
</html>